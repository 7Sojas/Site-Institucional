<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- LINKS -->
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="../img_one_page/img_calculadora/soja.ico">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <title>Dashboard - HOME</title>

</head>

<body onload="sessao()">

    <aside class="menu">

        <img src="src/logo.png" alt="Logo 7sojas">

        <nav>
            <ul>
                <li><a style="color: #5cff95;" href="index.html"><svg xmlns="http://www.w3.org/2000/svg" width="24"
                            height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list">
                            <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                            <path d="M12 11h4" />
                            <path d="M12 16h4" />
                            <path d="M8 11h.01" />
                            <path d="M8 16h.01" />

                        </svg> <span>DASHBOARD</span></a></li>
                <li><a href="sensores.html"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                            viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round" class="lucide lucide-waypoints">
                            <circle cx="12" cy="4.5" r="2.5" />
                            <path d="m10.2 6.3-3.9 3.9" />
                            <circle cx="4.5" cy="12" r="2.5" />
                            <path d="M7 12h10" />
                            <circle cx="19.5" cy="12" r="2.5" />
                            <path d="m13.8 17.7 3.9-3.9" />
                            <circle cx="12" cy="19.5" r="2.5" />
                        </svg><span>SENSORES</span></a></li>

            </ul>

            <ul>
                <li><a href="mailto:7sojas@gmail.com"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                            viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round" class="lucide lucide-heart-handshake">
                            <path
                                d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
                            <path
                                d="M12 5 9.04 7.96a2.17 2.17 0 0 0 0 3.08v0c.82.82 2.13.85 3 .07l2.07-1.9a2.82 2.82 0 0 1 3.79 0l2.96 2.66" />
                            <path d="m18 15-2-2" />
                            <path d="m15 18-2-2" />
                        </svg><span>AJUDA</span></a></li>
                <li><a href=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                            fill="none" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round" class="lucide lucide-log-out">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                            <polyline points="16 17 21 12 16 7" />
                            <line x1="21" x2="9" y1="12" y2="12" />
                        </svg><span>SAIR</span></a></li>
            </ul>

            <div>

                <a href="#">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-user">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </svg>
                    <span id="nomeUsuario">SOJAS BRASIL</span>
                </a>
            </div>
        </nav>

    </aside>

    <main>

        <div>

            <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none"
                stroke="#ffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-bar-chart-3">
                <path d="M3 3v18h18" />
                <path d="M18 17V9" />
                <path d="M13 17V5" />
                <path d="M8 17v-3" />
            </svg>
            <h1>INFORMAÇÕES DO <span style="color: #5cff95;">SILO <span id="id_silo">0</span></span></h1>
        </div>


        <div class="graficos">

            <div class="kpi-content">
                <div class="kpi-graficos-cards">
                    <h3>Temperatura</h3>
                    <p id="temperatura_media">23°</p>
                </div>
                <div class="kpi-graficos-cards">
                    <h3>Umidade</h3>
                    <p id="umidade_media"> 22% </p>
                </div>

                <div class="kpi-graficos-cards">
                    <div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="orange" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-circle-alert">
                            <circle cx="12" cy="12" r="10" />
                            <line x1="12" x2="12" y1="8" y2="12" />
                            <line x1="12" x2="12.01" y1="16" y2="16" />
                        </svg>
                        <h3>Sensores em alerta </h3>
                    </div>
                    <p> <span id="sensor_alerta">0</span>/<span id="qtd_sensor">0</span></p>
                </div>
            </div>
            

            <div class="graficos-cards">
                <h3> Gráficos diários de Temperatura</h3>
                <div id="graficos">

                </div>
            </div>
            <div class="graficos-cards">
                <h3> Gráficos diários de Umidade</h3>
                <div id="graficosUmidade">
                </div>
            </div>


        </div>
    </main>



    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <script src="//code.jivosite.com/widget/q3hkbM54dw" async></script>

    <script>

        const idSilos = sessionStorage.silo
        const listaIdSilos = idSilos.split(",")

        const queryString = window.location.search
        const params = new URLSearchParams(queryString)
        const id = params.get('id')

        

        for(let contador = 0; contador < listaIdSilos.length; contador++) {

            if(listaIdSilos[contador] == id) {
                id_silo.innerHTML = contador + 1
            }
            
        }

        fetch(`/propriedade/${id}/sensor`)
        .then(resposta => resposta.json())
        .then(data => {
            console.log(data[0])
            qtd_sensor.innerHTML = data[0].QTD_SENSOR
        })
        .catch(e => console.error(e))


        fetch(`/propriedade/${id}/sensor/alerta`)
        .then(resposta => resposta.json())
        .then(data => {
            sensor_alerta.innerHTML = data[0].SENSOR_ALERTA
        })
        .catch(e => console.error(e))

        fetch(`/propriedade/${id}/temperaturaUmidade/`)
        .then(resposta => resposta.json())
        .then(data => {
            console.log(data[0])

            umidade_media.innerHTML = `${data[0].UMIDADE_MEDIA}%`
            temperatura_media.innerHTML = `${data[0].TEMPERATURA_MEDIA}°C`
        })

        const temperatura = document.getElementById('temperatura');
        const umidade = document.getElementById('umidade');

        let charts = []; // Array para armazenar referências aos gráficos criados
    let chartsUmidade = [];

    //Temperatura

    function exibirSensoresTemperaturaDoUsuario() {
        var userIdVar = sessionStorage.getItem('ID_USUARIO');
        var numeroSensor = 1;

        fetch(`/sensor/consultarSensoresPropriedade/${userIdVar}`)
            .then(response => response.json())
            .then(sensor => {
                sessionStorage.SENSOR = JSON.stringify(sensor); // Armazena os sensores na sessão
                sensor.forEach(sensor => {
                    document.getElementById("graficos").innerHTML += `
                        <div id="grafico${sensor.id}" class="grafico-container">
                            <h3 class="tituloGraficos">
                                <span id="tituloSensor${sensor.id}">Sensor ${numeroSensor} - ID: ${sensor.id}</span>
                            </h3>
                            <div class="graph">
                                <canvas id="myChartCanvas${sensor.id}"></canvas>
                            </div>
                            <div class="label-captura">
                                <p id="avisoCaptura${sensor.id}" style="color: white"></p>
                            </div>
                        </div>
                    `;
                    numeroSensor += 1;
                });
                atualizarGraficos();
            })
            .catch(error => console.error('Erro ao obter sensores:', error));
    }

    function atualizarGraficos() {
        charts.forEach(chart => {
            chart.destroy(); // Remove o gráfico existente
        });
        charts = []; // Limpa o array de gráficos

        var userIdVar = sessionStorage.getItem('ID_USUARIO');
        fetch(`/sensor/consultarSensoresPropriedade/${userIdVar}`)
            .then(response => response.json())
            .then(sensor => {
                sensor.forEach(sensor => {
                    obterDadosGrafico(sensor.id);
                });
            })
            .catch(error => console.error('Erro ao obter sensores:', error));
    }

    function obterDadosGrafico(idSensor) {
        fetch(`/sensor/consultarLeituraTemperaturaSensor/${idSensor}`, { cache: 'no-store' }).then(function(response) {
            if (response.ok) {
                response.json().then(function(resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();
                    plotarGrafico(resposta, idSensor);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
        .catch(function(error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
    }

    function plotarGrafico(resposta, idSensor) {
        console.log('iniciando plotagem do gráfico...');

        let horarios = [];
        let dados = {
            labels: horarios,
            datasets: [{
                label: 'Temperatura',
                data: [],
                fill: false,
                borderColor: 'white',
                tension: 0.1
            }]
        };

        resposta.forEach(registro => {
            horarios.push(registro.dataHora);
            dados.datasets[0].data.push(registro.temperatura);
        });

        const config = {
            type: 'line',
            data: dados,
        };

        let ctx = document.getElementById(`myChartCanvas${idSensor}`).getContext('2d');
        let chart = new Chart(ctx, config);
        charts.push(chart); // Adiciona o gráfico ao array
    }

    //Umidade
    function exibirSensoresUmidadeDoUsuario() {
        var userIdVar = sessionStorage.getItem('ID_USUARIO');
        var numeroSensor = 1;

        fetch(`/sensor/consultarSensoresPropriedade/${userIdVar}`)
            .then(response => response.json())
            .then(sensor => {
                sessionStorage.SENSOR = JSON.stringify(sensor); // Armazena os sensores na sessão
                sensor.forEach(sensor => {
                    document.getElementById("graficosUmidade").innerHTML += `
                        <div id="graficoUmidade${sensor.id}" class="grafico-container">
                            <h3 class="tituloGraficos">
                                <span id="tituloSensorUmidade${sensor.id}">Sensor ${numeroSensor} - ID: ${sensor.id}</span>
                            </h3>
                            <div class="graph">
                                <canvas id="myChartCanvasUmidade${sensor.id}"></canvas>
                            </div>
                            <div class="label-captura">
                                <p id="avisoCaptura${sensor.id}" style="color: white"></p>
                            </div>
                        </div>
                    `;
                    numeroSensor += 1;
                });
                atualizarGraficosUmidade();
            })
            .catch(error => console.error('Erro ao obter sensores:', error));
    }

    function atualizarGraficosUmidade() {
        chartsUmidade.forEach(chart => {
            chart.destroy(); // Remove o gráfico existente
        });
        chartsUmidade = []; // Limpa o array de gráficos

        var userIdVar = sessionStorage.getItem('ID_USUARIO');
        fetch(`/sensor/consultarSensoresPropriedade/${userIdVar}`)
            .then(response => response.json())
            .then(sensor => {
                sensor.forEach(sensor => {
                    obterDadosGraficoUmidade(sensor.id);
                });
            })
            .catch(error => console.error('Erro ao obter sensores:', error));
    }

    function obterDadosGraficoUmidade(idSensor) {
        fetch(`/sensor/consultarUmidadeTemperaturaSensor/${idSensor}`, { cache: 'no-store' }).then(function(response) {
            if (response.ok) {
                response.json().then(function(resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();
                    plotarGraficoUmidade(resposta, idSensor);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
        .catch(function(error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
    }

    function plotarGraficoUmidade(resposta, idSensor) {
        console.log('iniciando plotagem do gráfico...');

        let horarios = [];
        let dados = {
            labels: horarios,
            datasets: [{
                label: 'Umidade',
                data: [],
                fill: false,
                borderColor: 'white',
                tension: 0.1
            }]
        };

        resposta.forEach(registro => {
            horarios.push(registro.dataHora);
            dados.datasets[0].data.push(registro.umidade);
        });

        const config = {
            type: 'line',
            data: dados,
        };

        let ctx = document.getElementById(`myChartCanvasUmidade${idSensor}`).getContext('2d');
        let chart = new Chart(ctx, config);
        chartsUmidade.push(chart); // Adiciona o gráfico ao array
        }

        function sessao() {
            const idUsuario = sessionStorage.ID_USUARIO;
            const nome = sessionStorage.NOME_USUARIO;
            nomeUsuario.innerHTML = nome;
        }

        // Inicializa os gráficos quando a página carrega
        window.onload = function() {
            exibirSensoresTemperaturaDoUsuario();
            setInterval(atualizarGraficos, 300000);
            exibirSensoresUmidadeDoUsuario();
            setInterval(atualizarGraficosUmidade, 300000);
        };

    </script>


</body>

</html>